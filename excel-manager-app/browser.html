<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æ•°æ®ç®¡ç†å™¨ - æµè§ˆå™¨ç‰ˆ</title>
    <!-- ä¿®å¤CSSè·¯å¾„ -->
    <link rel="stylesheet" href="src/renderer/styles/main.css">
    <style>
        /* å†…åµŒå…³é”®æ ·å¼ä»¥é˜²å¤–éƒ¨CSSåŠ è½½å¤±è´¥ */
        .status { padding: 12px; margin: 15px 0; border-radius: 6px; display: none; font-weight: 500; line-height: 1.5; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        /* å¤šé€‰åˆ—é€‰æ‹©å™¨æ ·å¼ */
        .column-selector { margin-bottom: 15px; display: none; }
        .column-selector h3 { margin-bottom: 15px; color: #333; }
        .column-section { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .recommended-section { background: #e8f5e8; border: 1px solid #4CAF50; }
        .all-columns-section { background: #f9f9f9; border: 1px solid #ddd; }
        .control-buttons { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; padding: 6px; border-radius: 4px; transition: background-color 0.2s; margin-bottom: 8px; }
        .checkbox-container:hover { background-color: #f0f0f0; }
        .checkbox-container input[type="checkbox"] { width: 16px; height: 16px; }
        .checkbox-container label { cursor: pointer; flex: 1; font-size: 14px; line-height: 1.4; }
        .category-group { margin-bottom: 15px; }
        .category-label { font-weight: bold; color: #555; margin-bottom: 8px; font-size: 14px; }
        .columns-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-left: 15px; }
        
        /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ä¿®å¤è¡¨æ ¼æ ·å¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .table th,
        .table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            font-size: 14px;
        }
        
        .table th {
            background: #4CAF50;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .table tr:hover {
            background: #e8f5e8;
        }
        
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* è®¡ç®—å™¨æ ·å¼ */
        .calc-select, .calc-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 100%;
        }

        .calc-select:focus, .calc-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
        }

        .calc-section {
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
        }

        .calculator-content {
            max-width: 100%;
        }

        .calculator-content input[type="radio"] + span {
            padding: 0.25rem 0;
        }

        .calculator-content label:has(input[type="radio"]:checked) {
            background: #f0f9ff;
            border-color: #0ea5e9;
            color: #0369a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excel æ•°æ®ç®¡ç†å™¨</h1>
            <p>æµè§ˆå™¨ç‰ˆ - ä¸Šä¼  Excel/CSV æ–‡ä»¶ï¼Œé€‰æ‹©ç­›é€‰åˆ—ï¼ŒæŒ‰æ¡ä»¶ç­›é€‰æ•°æ®ï¼Œä¸€é”®å¯¼å‡ºç»“æœ</p>
        </div>
        
        <div class="content">
            <!-- æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ -->
            <div class="section">
                <h2>ğŸ“ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ æ•°æ®æ–‡ä»¶</h2>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                <p class="help-text">æ”¯æŒ Excel (.xlsx, .xls) å’Œ CSV æ–‡ä»¶æ ¼å¼ï¼Œæ”¯æŒæ‹–æ‹½ä¸Šä¼ </p>
                <div id="fileStatus" class="status"></div>
                <div id="fileInfo" class="file-info" style="display: none;">
                    <strong>æ–‡ä»¶ä¿¡æ¯ï¼š</strong>
                    <div id="fileDetails"></div>
                </div>
                <div id="dataStats" class="data-stats" style="display: none;">
                    <strong>ğŸ“ˆ æ•°æ®æ¦‚è§ˆ</strong>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div id="totalRows" class="stat-number">0</div>
                            <div class="stat-label">æ€»è¡Œæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div id="totalColumns" class="stat-number">0</div>
                            <div class="stat-label">æ€»åˆ—æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div id="cityColumn" class="stat-number">-</div>
                            <div class="stat-label">ç­›é€‰åˆ—</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®ç­›é€‰ç»„ä»¶ -->
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>ğŸ” ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ç­›é€‰åˆ—å¹¶ç­›é€‰æ•°æ®</h2>
                    <button id="calcToggleBtn" class="button secondary" style="font-size: 0.875rem;">
                        ğŸ§® åˆ—è®¡ç®—å™¨
                    </button>
                </div>
                
                <!-- å¤šé€‰åˆ—é€‰æ‹©å™¨ -->
                <div id="columnSelector" class="column-selector">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ä¼šæ’å…¥è¿™é‡Œ -->
                </div>
                
                <!-- åŒ¹é…æ¨¡å¼é€‰æ‹© -->
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #e0e8f0;">
                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block;">ğŸ¯ åŒ¹é…æ¨¡å¼ï¼š</label>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="exact" checked>
                            <span>ç²¾ç¡®åŒ¹é…ï¼ˆå®Œå…¨ç›¸ç­‰ï¼‰</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="exactIgnoreCase">
                            <span>ç²¾ç¡®åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="contains">
                            <span>åŒ…å«åŒ¹é…ï¼ˆå¹¿ä¹‰æœç´¢ï¼‰</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="containsIgnoreCase">
                            <span>åŒ…å«åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰</span>
                        </label>
                    </div>
                </div>
                
                <!-- é€»è¾‘æ¨¡å¼é€‰æ‹©å™¨ - åªåœ¨å¤šé¡¹æœç´¢å¯ç”¨æ—¶æ˜¾ç¤º -->
                <div style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="multiSearch" checked>
                        <span style="font-weight: bold; color: #4CAF50;">ğŸ” å¤šé¡¹æœç´¢ï¼ˆç”¨é€—å·åˆ†éš”å¤šä¸ªæœç´¢è¯ï¼‰</span>
                    </label>
                    
                    <!-- é€»è¾‘æ¨¡å¼é€‰æ‹©å™¨ - åµŒå¥—åœ¨å¤šé¡¹æœç´¢ä¸‹é¢ -->
                    <div id="logicModeSelector" style="margin-top: 8px; margin-left: 25px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; display: block;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block;">ğŸ”— å¤šé¡¹æœç´¢é€»è¾‘ï¼š</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="logicMode" value="or" checked>
                                <span>ORæ¨¡å¼ï¼ˆä»»ä¸€æ¡ä»¶æ»¡è¶³ï¼‰</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="logicMode" value="and">
                                <span>ANDæ¨¡å¼ï¼ˆæ‰€æœ‰æ¡ä»¶éƒ½è¦æ»¡è¶³ï¼‰</span>
                            </label>
                        </div>
                        <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
                            ğŸ’¡ ORæ¨¡å¼ï¼šæœç´¢"åŒ—äº¬,ä¸Šæµ·"æ—¶ï¼ŒåŒ…å«åŒ—äº¬æˆ–ä¸Šæµ·çš„æ•°æ®éƒ½ä¼šæ˜¾ç¤º<br>
                            ğŸ’¡ ANDæ¨¡å¼ï¼šæœç´¢"åŒ—äº¬,2023"æ—¶ï¼ŒåŒæ—¶åŒ…å«åŒ—äº¬å’Œ2023çš„æ•°æ®æ‰ä¼šæ˜¾ç¤º
                        </p>
                    </div>
                </div>
                
                <p style="font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 0;">
                    ğŸ’¡ <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    â€¢ ç²¾ç¡®åŒ¹é…ï¼šè¾“å…¥å€¼å¿…é¡»ä¸æ•°æ®å®Œå…¨ä¸€è‡´<br>
                    â€¢ åŒ…å«åŒ¹é…ï¼šæ•°æ®ä¸­åŒ…å«è¾“å…¥å€¼å³å¯åŒ¹é…<br>
                    â€¢ å¤šé¡¹æœç´¢ï¼šç”¨é€—å·åˆ†éš”ï¼Œæ”¯æŒä¸­è‹±æ–‡é€—å·ï¼Œå¦‚"åŒ—äº¬,ä¸Šæµ·,å¹¿å·"æˆ–"åŒ—äº¬ï¼Œä¸Šæµ·ï¼Œå¹¿å·"<br><br>
                </p>
                
                <!-- ç­›é€‰è¾“å…¥ -->
                <input type="text" id="cityInput" class="text-input" placeholder="è¾“å…¥æœç´¢è¯ï¼Œå¤šä¸ªè¯ç”¨é€—å·åˆ†éš”ï¼ˆæ”¯æŒä¸­è‹±æ–‡é€—å·ï¼‰ï¼Œå¦‚ï¼šåŒ—äº¬,ä¸Šæµ·,å¹¿å· æˆ– åŒ—äº¬ï¼Œä¸Šæµ·ï¼Œå¹¿å·" disabled><br><br>
                <button id="filterBtn" class="button" disabled>ğŸ” æ™ºèƒ½ç­›é€‰</button>
                <button id="clearFilterBtn" class="button secondary" disabled>ğŸ—‘ï¸ æ¸…é™¤ç­›é€‰</button>
                <div id="filterStatus" class="status"></div>
            </div>

            <!-- åˆ—è®¡ç®—å™¨ -->
            <div id="columnCalculator" class="section" style="display: none;">
                <h2>ğŸ§® åˆ—è®¡ç®—å™¨</h2>
                <div class="calculator-content">
                    <!-- è®¡ç®—ç±»å‹é€‰æ‹© -->
                    <div class="calc-type-selector" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">è®¡ç®—ç±»å‹ï¼š</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="radio" name="calcType" value="numeric" checked>
                                <span>æ•°å€¼è®¡ç®—</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="radio" name="calcType" value="text">
                                <span>æ–‡æœ¬æ“ä½œ</span>
                            </label>
                        </div>
                    </div>

                    <!-- æ•°å€¼è®¡ç®—åŒºåŸŸ -->
                    <div id="numericCalc" class="calc-section">
                        <div class="calc-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">åˆ—Aï¼š</label>
                                <select id="columnA" class="calc-select">
                                    <option value="">é€‰æ‹©åˆ—</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">
                                <span id="operationSymbol">+</span>
                            </div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">åˆ—Bï¼š</label>
                                <select id="columnB" class="calc-select">
                                    <option value="">é€‰æ‹©åˆ—</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">=</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">æ–°åˆ—åï¼š</label>
                                <input type="text" id="newColumnName" class="calc-input" placeholder="è¾“å…¥æ–°åˆ—å">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">è¿ç®—ç±»å‹ï¼š</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="add" checked>
                                    <span>åŠ æ³• (+)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="subtract">
                                    <span>å‡æ³• (-)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="multiply">
                                    <span>ä¹˜æ³• (Ã—)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="divide">
                                    <span>é™¤æ³• (Ã·)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="percentage">
                                    <span>ç™¾åˆ†æ¯” (%)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡æœ¬æ“ä½œåŒºåŸŸ -->
                    <div id="textCalc" class="calc-section" style="display: none;">
                        <div class="calc-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">åˆ—Aï¼š</label>
                                <select id="textColumnA" class="calc-select">
                                    <option value="">é€‰æ‹©åˆ—</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">+</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">åˆ—Bï¼š</label>
                                <select id="textColumnB" class="calc-select">
                                    <option value="">é€‰æ‹©åˆ—</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">=</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">æ–°åˆ—åï¼š</label>
                                <input type="text" id="textNewColumnName" class="calc-input" placeholder="è¾“å…¥æ–°åˆ—å">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">è¿æ¥ç¬¦ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                            <input type="text" id="textSeparator" class="calc-input" placeholder="å¦‚ï¼š-, _, ç©ºæ ¼ç­‰" style="max-width: 200px;">
                            <div class="help-text">ç•™ç©ºåˆ™ç›´æ¥è¿æ¥ï¼Œè¾“å…¥ç¬¦å·åˆ™åœ¨ä¸¤åˆ—ä¹‹é—´æ’å…¥</div>
                        </div>
                    </div>

                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="calcPreview" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 0.5rem;">ğŸ“‹ è®¡ç®—é¢„è§ˆï¼ˆå‰5è¡Œï¼‰</h4>
                        <div id="previewTable"></div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                        <button id="previewCalcBtn" class="button secondary">ğŸ‘ï¸ é¢„è§ˆè®¡ç®—</button>
                        <button id="executeCalcBtn" class="button" disabled>âœ… æ‰§è¡Œè®¡ç®—</button>
                        <button id="clearCalcBtn" class="button secondary">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>

                    <!-- å·²æœ‰è®¡ç®—åˆ—ç®¡ç† -->
                    <div id="existingCalcColumns" style="margin-top: 1.5rem; display: none;">
                        <h4>ğŸ“Š å·²åˆ›å»ºçš„è®¡ç®—åˆ—</h4>
                        <div id="calcColumnsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®å¯¼å‡ºç»„ä»¶ -->
            <div class="section">
                <h2>ğŸ“¤ ç¬¬ä¸‰æ­¥ï¼šå¯¼å‡ºæ•°æ®</h2>
                <div class="export-options">
                    <input type="text" id="filenameInput" class="filename-input" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰">
                    <button id="exportCSVBtn" class="button" disabled>ğŸ’¾ å¯¼å‡º CSV</button>
                    <button id="exportExcelBtn" class="button secondary" disabled>ğŸ“Š å¯¼å‡º Excelå…¼å®¹</button>
                </div>
                <div id="exportStatus" class="status"></div>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆ -->
            <div id="results" class="results" style="display: none;">
                <h3>ğŸ“‹ æ•°æ®é¢„è§ˆ</h3>
                <div id="dataPreview"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    console.log('ğŸš€ å¼€å§‹åŠ è½½å®Œæ•´åŠŸèƒ½...');

    // æ£€æŸ¥XLSXåº“
    if (typeof XLSX === 'undefined') {
        alert('XLSXåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }

    // ç®€åŒ–çš„ExcelManagerç±» - å¢å¼ºç‰ˆ
    class EnhancedExcelManager {
        constructor() {
            this.excelData = [];
            this.filteredData = [];
            this.selectedColumns = [];
            this.availableColumns = [];
            this.calculatedColumns = new Map(); // å­˜å‚¨è®¡ç®—åˆ—çš„å®šä¹‰
            this.operationTypes = {
                'add': { label: 'åŠ æ³• (+)', symbol: '+', operation: (a, b) => a + b },
                'subtract': { label: 'å‡æ³• (-)', symbol: '-', operation: (a, b) => a - b },
                'multiply': { label: 'ä¹˜æ³• (Ã—)', symbol: 'Ã—', operation: (a, b) => a * b },
                'divide': { label: 'é™¤æ³• (Ã·)', symbol: 'Ã·', operation: (a, b) => b !== 0 ? a / b : 'é™¤é›¶é”™è¯¯' },
                'percentage': { label: 'ç™¾åˆ†æ¯” (A/BÃ—100)', symbol: '%', operation: (a, b) => b !== 0 ? (a / b * 100).toFixed(2) + '%' : 'é™¤é›¶é”™è¯¯' }
            };
            
            this.init();
        }

        init() {
            console.log('ğŸš€ åˆå§‹åŒ–å¢å¼ºç‰ˆExcelç®¡ç†å™¨...');
            
            // å¤šé¡¹æœç´¢å¤é€‰æ¡†äº‹ä»¶
            const multiSearchCheckbox = document.getElementById('multiSearch');
            const logicModeSelector = document.getElementById('logicModeSelector');
            
            if (multiSearchCheckbox && logicModeSelector) {
                const updateLogicModeVisibility = () => {
                    logicModeSelector.style.display = multiSearchCheckbox.checked ? 'block' : 'none';
                };
                
                updateLogicModeVisibility();
                multiSearchCheckbox.addEventListener('change', updateLogicModeVisibility);
                console.log('âœ… å¤šé¡¹æœç´¢å’Œé€»è¾‘æ¨¡å¼é€‰æ‹©å™¨äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            this.bindEvents();
            this.initCalculator();
        }

        initCalculator() {
            // è®¡ç®—å™¨åˆ‡æ¢æŒ‰é’®
            const calcToggleBtn = document.getElementById('calcToggleBtn');
            if (calcToggleBtn) {
                calcToggleBtn.addEventListener('click', () => this.toggleCalculator());
            }

            // è®¡ç®—ç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="calcType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const numericCalc = document.getElementById('numericCalc');
                    const textCalc = document.getElementById('textCalc');
                    
                    if (e.target.value === 'numeric') {
                        numericCalc.style.display = 'block';
                        textCalc.style.display = 'none';
                    } else {
                        numericCalc.style.display = 'none';
                        textCalc.style.display = 'block';
                    }
                    this.clearPreview();
                });
            });

            // è¿ç®—ç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="operation"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const symbol = this.operationTypes[e.target.value].symbol;
                    document.getElementById('operationSymbol').textContent = symbol;
                    this.clearPreview();
                });
            });

            // é¢„è§ˆå’Œæ‰§è¡ŒæŒ‰é’®
            document.getElementById('previewCalcBtn').addEventListener('click', () => this.previewCalculation());
            document.getElementById('executeCalcBtn').addEventListener('click', () => this.executeCalculation());
            document.getElementById('clearCalcBtn').addEventListener('click', () => this.clearCalculator());
        }

        bindEvents() {
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    console.log('ğŸ“ æ–‡ä»¶changeäº‹ä»¶è§¦å‘');
                    this.handleFileUpload(e);
                });
                console.log('âœ… æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }

            // ç­›é€‰æŒ‰é’®
            const filterBtn = document.getElementById('filterBtn');
            if (filterBtn) {
                filterBtn.addEventListener('click', () => this.handleFilter());
            }

            // æ¸…é™¤ç­›é€‰æŒ‰é’®
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener('click', () => this.clearFilter());
            }

            // å¯¼å‡ºæŒ‰é’®
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', () => this.exportCSV());
            }

            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => this.exportExcel());
            }
        }

        // æ˜¾ç¤º/éšè—è®¡ç®—å™¨
        toggleCalculator() {
            const calculator = document.getElementById('columnCalculator');
            if (calculator) {
                const isVisible = calculator.style.display !== 'none';
                calculator.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    this.updateCalculatorOptions();
                }
            }
        }

        // æ›´æ–°è®¡ç®—å™¨é€‰é¡¹
        updateCalculatorOptions() {
            const { numericColumns, allColumns } = this.getAvailableColumns();
            
            console.log('ğŸ”„ æ›´æ–°è®¡ç®—å™¨é€‰é¡¹:', { 
                æ•°å€¼åˆ—: numericColumns, 
                æ‰€æœ‰åˆ—: allColumns 
            });
            
            const updateSelect = (selectId, columns) => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">é€‰æ‹©åˆ—</option>' + 
                        columns.map(col => {
                            // ä¸ºè®¡ç®—åˆ—æ·»åŠ æ ‡è¯†
                            const isCalculated = this.calculatedColumns.has(col);
                            const label = isCalculated ? `ğŸ§® ${col} (è®¡ç®—åˆ—)` : `ğŸ“„ ${col}`;
                            return `<option value="${col}">${label}</option>`;
                        }).join('');
                    
                    // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼ï¼ˆå¦‚æœä»ç„¶å¯ç”¨ï¼‰
                    if (columns.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }
            };

            updateSelect('columnA', numericColumns);
            updateSelect('columnB', numericColumns);
            updateSelect('textColumnA', allColumns);
            updateSelect('textColumnB', allColumns);
        }

        // è·å–å¯ç”¨äºè®¡ç®—çš„åˆ—
        getAvailableColumns() {
            const numericColumns = [];
            const allColumns = [...this.availableColumns]; // å¼€å§‹æ—¶åŒ…å«æ‰€æœ‰åŸå§‹åˆ—

            // æ·»åŠ å·²è®¡ç®—çš„åˆ—
            this.calculatedColumns.forEach((definition, columnName) => {
                if (!allColumns.includes(columnName)) {
                    allColumns.push(columnName);
                }
            });

            // æ£€æŸ¥å“ªäº›åˆ—æ˜¯æ•°å€¼åˆ—
            allColumns.forEach(column => {
                if (this.isNumericColumn(column)) {
                    numericColumns.push(column);
                }
            });

            console.log('ğŸ“Š å¯ç”¨åˆ—æ›´æ–°:', { 
                åŸå§‹åˆ—: this.availableColumns.length, 
                è®¡ç®—åˆ—: this.calculatedColumns.size, 
                æ€»åˆ—æ•°: allColumns.length, 
                æ•°å€¼åˆ—: numericColumns.length 
            });

            return { numericColumns, allColumns };
        }

        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºæ•°å€¼åˆ—
        isNumericColumn(columnName) {
            // å¦‚æœæ˜¯è®¡ç®—åˆ—ï¼Œæ ¹æ®å…¶å®šä¹‰åˆ¤æ–­ç±»å‹
            if (this.calculatedColumns.has(columnName)) {
                const definition = this.calculatedColumns.get(columnName);
                return definition.type === 'numeric';
            }
            
            // åŸå§‹åˆ—çš„æ•°å€¼æ£€æµ‹
            const sampleData = this.excelData.slice(0, Math.min(10, this.excelData.length));
            if (sampleData.length === 0) return false;
            
            let numericCount = 0;
            
            for (const row of sampleData) {
                const value = row[columnName];
                if (value !== null && value !== undefined && value !== '') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        numericCount++;
                    }
                }
            }
            
            return numericCount > sampleData.length * 0.5;
        }

        // é¢„è§ˆè®¡ç®—ç»“æœ
        previewCalculation() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            
            if (calcType === 'numeric') {
                this.previewNumericCalculation();
            } else {
                this.previewTextCalculation();
            }
        }

        // é¢„è§ˆæ•°å€¼è®¡ç®—
        previewNumericCalculation() {
            const columnA = document.getElementById('columnA').value;
            const columnB = document.getElementById('columnB').value;
            const newColumnName = document.getElementById('newColumnName').value.trim();
            const operation = document.querySelector('input[name="operation"]:checked').value;

            if (!columnA || !columnB || !newColumnName) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªåˆ—å¹¶è¾“å…¥æ–°åˆ—å');
                return;
            }

            if (this.availableColumns.includes(newColumnName) || this.calculatedColumns.has(newColumnName)) {
                alert('åˆ—åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            const preview = this.generateNumericPreview(columnA, columnB, newColumnName, operation);
            this.showPreview(preview);
        }

        // é¢„è§ˆæ–‡æœ¬æ“ä½œ
        previewTextCalculation() {
            const columnA = document.getElementById('textColumnA').value;
            const columnB = document.getElementById('textColumnB').value;
            const newColumnName = document.getElementById('textNewColumnName').value.trim();
            const separator = document.getElementById('textSeparator').value;

            if (!columnA || !columnB || !newColumnName) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªåˆ—å¹¶è¾“å…¥æ–°åˆ—å');
                return;
            }

            if (this.availableColumns.includes(newColumnName) || this.calculatedColumns.has(newColumnName)) {
                alert('åˆ—åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            const preview = this.generateTextPreview(columnA, columnB, newColumnName, separator);
            this.showPreview(preview);
        }

        // ç”Ÿæˆæ•°å€¼è®¡ç®—é¢„è§ˆ
        generateNumericPreview(columnA, columnB, newColumnName, operation) {
            const operationFunc = this.operationTypes[operation].operation;
            const previewData = this.excelData.slice(0, 5);
            
            return previewData.map(row => {
                const valueA = this.getNumericValue(row[columnA]);
                const valueB = this.getNumericValue(row[columnB]);
                const result = operationFunc(valueA, valueB);
                
                return {
                    [columnA]: row[columnA],
                    [columnB]: row[columnB],
                    [newColumnName]: result
                };
            });
        }

        // ç”Ÿæˆæ–‡æœ¬æ“ä½œé¢„è§ˆ
        generateTextPreview(columnA, columnB, newColumnName, separator = '') {
            const previewData = this.excelData.slice(0, 5);
            
            return previewData.map(row => {
                const valueA = (row[columnA] || '').toString();
                const valueB = (row[columnB] || '').toString();
                const result = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
                
                return {
                    [columnA]: row[columnA],
                    [columnB]: row[columnB],
                    [newColumnName]: result
                };
            });
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        showPreview(previewData) {
            const previewContainer = document.getElementById('calcPreview');
            const previewTable = document.getElementById('previewTable');
            
            if (previewData.length === 0) {
                previewTable.innerHTML = '<p>æ²¡æœ‰æ•°æ®å¯é¢„è§ˆ</p>';
                previewContainer.style.display = 'block';
                return;
            }

            const columns = Object.keys(previewData[0]);
            let html = '<table class="table" style="font-size: 0.875rem;"><thead><tr>';
            
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            previewTable.innerHTML = html;
            previewContainer.style.display = 'block';
            
            // å¯ç”¨æ‰§è¡ŒæŒ‰é’®
            document.getElementById('executeCalcBtn').disabled = false;
        }

        // æ‰§è¡Œè®¡ç®—
        executeCalculation() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            
            if (calcType === 'numeric') {
                this.executeNumericCalculation();
            } else {
                this.executeTextCalculation();
            }
        }

        // æ‰§è¡Œæ•°å€¼è®¡ç®—
        executeNumericCalculation() {
            const columnA = document.getElementById('columnA').value;
            const columnB = document.getElementById('columnB').value;
            const newColumnName = document.getElementById('newColumnName').value.trim();
            const operation = document.querySelector('input[name="operation"]:checked').value;

            const operationFunc = this.operationTypes[operation].operation;
            
            // ä¸ºæ‰€æœ‰æ•°æ®æ·»åŠ æ–°åˆ—
            this.excelData.forEach(row => {
                const valueA = this.getNumericValue(row[columnA]);
                const valueB = this.getNumericValue(row[columnB]);
                row[newColumnName] = operationFunc(valueA, valueB);
            });

            // å¦‚æœæœ‰ç­›é€‰æ•°æ®ï¼Œä¹Ÿè¦æ›´æ–°
            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    const valueA = this.getNumericValue(row[columnA]);
                    const valueB = this.getNumericValue(row[columnB]);
                    row[newColumnName] = operationFunc(valueA, valueB);
                });
            }

            // è®°å½•è®¡ç®—åˆ—å®šä¹‰
            this.calculatedColumns.set(newColumnName, {
                type: 'numeric',
                columnA,
                columnB,
                operation,
                formula: `${columnA} ${this.operationTypes[operation].symbol} ${columnB}`
            });

            this.completeCalculation(newColumnName);
        }

        // æ‰§è¡Œæ–‡æœ¬æ“ä½œ
        executeTextCalculation() {
            const columnA = document.getElementById('textColumnA').value;
            const columnB = document.getElementById('textColumnB').value;
            const newColumnName = document.getElementById('textNewColumnName').value.trim();
            const separator = document.getElementById('textSeparator').value;

            // ä¸ºæ‰€æœ‰æ•°æ®æ·»åŠ æ–°åˆ—
            this.excelData.forEach(row => {
                const valueA = (row[columnA] || '').toString();
                const valueB = (row[columnB] || '').toString();
                row[newColumnName] = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
            });

            // å¦‚æœæœ‰ç­›é€‰æ•°æ®ï¼Œä¹Ÿè¦æ›´æ–°
            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    const valueA = (row[columnA] || '').toString();
                    const valueB = (row[columnB] || '').toString();
                    row[newColumnName] = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
                });
            }

            // è®°å½•è®¡ç®—åˆ—å®šä¹‰
            this.calculatedColumns.set(newColumnName, {
                type: 'text',
                columnA,
                columnB,
                separator,
                formula: separator ? `${columnA} + "${separator}" + ${columnB}` : `${columnA} + ${columnB}`
            });

            this.completeCalculation(newColumnName);
        }

        // å®Œæˆè®¡ç®—åçš„æ“ä½œ
        completeCalculation(newColumnName) {
            // æ›´æ–°å¯ç”¨åˆ—åˆ—è¡¨
            if (!this.availableColumns.includes(newColumnName)) {
                this.availableColumns.push(newColumnName);
            }
            
            // é‡æ–°æ„å»ºåˆ—é€‰æ‹©å™¨
            this.buildColumnSelector();
            
            // æ›´æ–°æ•°æ®ç»Ÿè®¡
            this.showDataStats();
            
            // æ›´æ–°é¢„è§ˆ
            this.displayPreview();
            
            // ğŸ’¡ å…³é”®ï¼šæ›´æ–°è®¡ç®—å™¨é€‰é¡¹ï¼Œè®©æ–°åˆ—å¯ä»¥å‚ä¸ä¸‹æ¬¡è®¡ç®—
            this.updateCalculatorOptions();
            
            // æ›´æ–°å·²æœ‰è®¡ç®—åˆ—åˆ—è¡¨
            this.updateExistingCalculatedColumns();
            
            // æ¸…é™¤è®¡ç®—å™¨è¾“å…¥
            this.clearCalculator();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            this.showStatus('filterStatus', 
                `ğŸ‰ è®¡ç®—åˆ—"${newColumnName}"åˆ›å»ºæˆåŠŸï¼\n` +
                `å…¬å¼ï¼š${this.calculatedColumns.get(newColumnName).formula}\n` +
                `âœ… å·²æ·»åŠ åˆ°æ•°æ®è¡¨ä¸­ï¼Œå¯ä»¥å‚ä¸ç­›é€‰ã€å¯¼å‡ºå’Œä¸‹ä¸€æ­¥è®¡ç®—ã€‚`, 
                'success'
            );
        }

        // æ›´æ–°å·²æœ‰è®¡ç®—åˆ—åˆ—è¡¨
        updateExistingCalculatedColumns() {
            const container = document.getElementById('existingCalcColumns');
            const list = document.getElementById('calcColumnsList');
            
            if (this.calculatedColumns.size === 0) {
                container.style.display = 'none';
                return;
            }

            let html = '<div style="display: grid; gap: 0.5rem;">';
            this.calculatedColumns.forEach((definition, columnName) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 0.25rem; border: 1px solid #e9ecef;">
                        <div>
                            <strong>${columnName}</strong>
                            <span style="margin-left: 0.5rem; color: #666; font-size: 0.875rem;">${definition.formula}</span>
                        </div>
                        <button onclick="window.excelApp.removeCalculatedColumn('${columnName}')" 
                                class="button secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">åˆ é™¤</button>
                    </div>
                `;
            });
            html += '</div>';
            
            list.innerHTML = html;
            container.style.display = 'block';
        }

        // åˆ é™¤è®¡ç®—åˆ—
        removeCalculatedColumn(columnName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¡ç®—åˆ—"${columnName}"å—ï¼Ÿ`)) {
                return;
            }

            // ä»æ•°æ®ä¸­ç§»é™¤è¯¥åˆ—
            this.excelData.forEach(row => {
                delete row[columnName];
            });

            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    delete row[columnName];
                });
            }

            // ä»å¯ç”¨åˆ—ä¸­ç§»é™¤
            this.availableColumns = this.availableColumns.filter(col => col !== columnName);
            
            // ä»é€‰ä¸­åˆ—ä¸­ç§»é™¤
            this.selectedColumns = this.selectedColumns.filter(col => col !== columnName);
            
            // åˆ é™¤è®¡ç®—åˆ—å®šä¹‰
            this.calculatedColumns.delete(columnName);
            
            // æ›´æ–°ç•Œé¢
            this.buildColumnSelector();
            this.displayPreview();
            this.updateExistingCalculatedColumns();
            
            this.showStatus('filterStatus', `è®¡ç®—åˆ—"${columnName}"å·²åˆ é™¤`, 'info');
        }

        // è·å–æ•°å€¼
        getNumericValue(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        // æ¸…é™¤é¢„è§ˆ
        clearPreview() {
            document.getElementById('calcPreview').style.display = 'none';
            document.getElementById('executeCalcBtn').disabled = true;
        }

        // æ¸…é™¤è®¡ç®—å™¨
        clearCalculator() {
            document.getElementById('columnA').value = '';
            document.getElementById('columnB').value = '';
            document.getElementById('newColumnName').value = '';
            document.getElementById('textColumnA').value = '';
            document.getElementById('textColumnB').value = '';
            document.getElementById('textNewColumnName').value = '';
            document.getElementById('textSeparator').value = '';
            
            // é‡ç½®ä¸ºåŠ æ³•
            document.querySelector('input[name="operation"][value="add"]').checked = true;
            document.getElementById('operationSymbol').textContent = '+';
            
            this.clearPreview();
        }

        // æ–‡ä»¶ä¸Šä¼ å®Œæˆå
        onFileLoaded() {
            // æ˜¾ç¤ºè®¡ç®—å™¨
            const calculator = document.getElementById('columnCalculator');
            if (calculator) {
                this.updateCalculatorOptions();
            }
        }

        // ä»¥ä¸‹æ˜¯åŸæœ‰çš„æ–¹æ³•ï¼Œä¿æŒä¸å˜...
        async handleFileUpload(event) {
            console.log('ğŸ¯ å¤„ç†æ–‡ä»¶ä¸Šä¼ ...');
            
            const file = event.target.files[0];
            if (!file) {
                console.log('âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }

            console.log('ğŸ“ æ–‡ä»¶ä¿¡æ¯:', file.name, file.size, file.type);

            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            this.showStatus('fileStatus', 'ğŸ“‹ æ­£åœ¨å¤„ç†æ–‡ä»¶...', 'info');

            // é‡ç½®æ•°æ®
            this.excelData = [];
            this.filteredData = [];
            this.selectedColumns = [];
            this.availableColumns = [];

            try {
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv')) {
                    console.log('ğŸ“„ å¤„ç†CSVæ–‡ä»¶');
                    await this.handleCSVFile(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    console.log('ğŸ“Š å¤„ç†Excelæ–‡ä»¶');
                    await this.handleExcelFile(file);
                } else {
                    this.showStatus('fileStatus', 'âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼\næ”¯æŒ: .xlsx, .xls, .csv', 'error');
                }
            } catch (error) {
                console.error('âŒ æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                this.showStatus('fileStatus', `âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async handleCSVFile(file) {
            try {
                console.log('ğŸ“„ å¼€å§‹å¤„ç†CSVæ–‡ä»¶ï¼Œå°è¯•å¤šç§ç¼–ç ...');
                
                // å°è¯•å¤šç§ç¼–ç 
                const encodings = ['UTF-8', 'GBK', 'GB2312', 'GB18030'];
                let text = null;
                let usedEncoding = 'UTF-8';
                
                for (const encoding of encodings) {
                    try {
                        console.log(`ğŸ” å°è¯• ${encoding} ç¼–ç ...`);
                        text = await this.readFileAsTextWithEncoding(file, encoding);
                        
                        // ç®€å•çš„ä¹±ç æ£€æµ‹
                        if (text && !this.hasGarbledText(text)) {
                            usedEncoding = encoding;
                            console.log(`âœ… ${encoding} ç¼–ç æˆåŠŸ`);
                            break;
                        }
                    } catch (error) {
                        console.log(`âŒ ${encoding} ç¼–ç å¤±è´¥:`, error.message);
                    }
                }
                
                if (!text) {
                    // æœ€åå°è¯•æµè§ˆå™¨è‡ªåŠ¨æ£€æµ‹
                    console.log('ğŸ” å°è¯•æµè§ˆå™¨è‡ªåŠ¨æ£€æµ‹ç¼–ç ...');
                    text = await this.readFileAsText(file);
                    usedEncoding = 'è‡ªåŠ¨æ£€æµ‹';
                }
                
                if (!text) {
                    throw new Error('æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                }
                
                console.log(`ğŸ“„ ä½¿ç”¨ ${usedEncoding} ç¼–ç è¯»å–æˆåŠŸï¼Œå†…å®¹é•¿åº¦:`, text.length);
                this.parseCSVData(text, file.name);
                
            } catch (error) {
                throw new Error(`CSVè¯»å–å¤±è´¥: ${error.message}`);
            }
        }

        async handleExcelFile(file) {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excelå¤„ç†åº“æœªåŠ è½½');
                }

                const arrayBuffer = await this.readFileAsArrayBuffer(file);
                console.log('ğŸ“Š Excelæ–‡ä»¶è¯»å–æˆåŠŸï¼Œå¤§å°:', arrayBuffer.byteLength);
                
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                console.log('ğŸ“Š å·¥ä½œè¡¨:', workbook.SheetNames);
                
                if (!workbook.SheetNames.length) {
                    throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨');
                }

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                if (jsonData.length < 2) {
                    throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®');
                }

                // å¤„ç†æ•°æ®
                const headers = jsonData[0].filter(h => h && h.toString().trim());
                const dataRows = jsonData.slice(1).filter(row => 
                    row.some(cell => cell && cell.toString().trim())
                );

                this.excelData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] ? row[index].toString() : '';
                    });
                    return obj;
                });

                this.availableColumns = headers;
                
                this.showStatus('fileStatus', 
                    `âœ… Excelæ–‡ä»¶å¤„ç†æˆåŠŸï¼\næ–‡ä»¶: ${file.name}\næ•°æ®: ${this.excelData.length} è¡Œï¼Œ${headers.length} åˆ—`, 
                    'success'
                );
                
                this.buildColumnSelector();
                this.showDataStats();
                this.displayPreview();
                this.onFileLoaded(); // æ–‡ä»¶åŠ è½½å®Œæˆåçš„å›è°ƒ

            } catch (error) {
                throw new Error(`Excelå¤„ç†å¤±è´¥: ${error.message}`);
            }
        }

        parseCSVData(text, filename) {
            try {
                // ç®€å•çš„CSVè§£æ
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('CSVæ–‡ä»¶å†…å®¹ä¸è¶³');
                }

                const headers = this.parseCSVLine(lines[0]);
                console.log('ğŸ“„ CSVæ ‡é¢˜:', headers);

                this.excelData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = this.parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        this.excelData.push(row);
                    }
                }

                this.availableColumns = headers;
                
                this.showStatus('fileStatus', 
                    `âœ… CSVæ–‡ä»¶å¤„ç†æˆåŠŸï¼\næ–‡ä»¶: ${filename}\næ•°æ®: ${this.excelData.length} è¡Œï¼Œ${headers.length} åˆ—`, 
                    'success'
                );
                
                this.buildColumnSelector();
                this.showDataStats();
                this.displayPreview();
                this.onFileLoaded(); // æ–‡ä»¶åŠ è½½å®Œæˆåçš„å›è°ƒ

            } catch (error) {
                throw new Error(`CSVè§£æå¤±è´¥: ${error.message}`);
            }
        }

        parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        buildColumnSelector() {
            const columnSelector = document.getElementById('columnSelector');
            if (!columnSelector || !this.availableColumns.length) return;

            let html = `
                <h3>ğŸ¯ é€‰æ‹©è¦ç­›é€‰çš„åˆ— <span id="selectedCount">0</span> / ${this.availableColumns.length}</h3>
                <div style="margin-bottom: 15px;">
                    <button onclick="window.excelApp.selectAllColumns()" class="button">å…¨é€‰</button>
                    <button onclick="window.excelApp.clearAllColumns()" class="button secondary">æ¸…ç©º</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            `;

            this.availableColumns.forEach(column => {
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" value="${column}" onchange="window.excelApp.toggleColumn('${column}')">
                        <span>ğŸ“„ ${column}</span>
                    </label>
                `;
            });

            html += '</div>';
            columnSelector.innerHTML = html;
            columnSelector.style.display = 'block';
        }

        toggleColumn(column) {
            if (this.selectedColumns.includes(column)) {
                this.selectedColumns = this.selectedColumns.filter(col => col !== column);
            } else {
                this.selectedColumns.push(column);
            }
            this.updateSelectedCount();
            this.updateButtons();
        }

        selectAllColumns() {
            this.selectedColumns = [...this.availableColumns];
            this.updateCheckboxes();
            this.updateSelectedCount();
            this.updateButtons();
        }

        clearAllColumns() {
            this.selectedColumns = [];
            this.updateCheckboxes();
            this.updateSelectedCount();
            this.updateButtons();
        }

        updateCheckboxes() {
            const checkboxes = document.querySelectorAll('#columnSelector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.selectedColumns.includes(checkbox.value);
            });
        }

        updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = this.selectedColumns.length;
            }
        }

        updateButtons() {
            const filterBtn = document.getElementById('filterBtn');
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const cityInput = document.getElementById('cityInput');

            const hasData = this.excelData.length > 0;
            const hasSelectedColumns = this.selectedColumns.length > 0;

            if (filterBtn) {
                filterBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (exportCSVBtn) {
                exportCSVBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (exportExcelBtn) {
                exportExcelBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (cityInput) {
                cityInput.disabled = !hasData || !hasSelectedColumns;
                
                if (hasSelectedColumns) {
                    cityInput.placeholder = `åœ¨æ‰€é€‰ ${this.selectedColumns.length} åˆ—ä¸­æœç´¢ï¼ˆæ”¯æŒä¸­è‹±æ–‡é€—å·åˆ†éš”ï¼‰...`;
                } else {
                    cityInput.placeholder = 'è¯·å…ˆé€‰æ‹©è¦ç­›é€‰çš„åˆ—';
                }
            }
        }

        showDataStats() {
            const dataStats = document.getElementById('dataStats');
            const totalRows = document.getElementById('totalRows');
            const totalColumns = document.getElementById('totalColumns');
            const cityColumn = document.getElementById('cityColumn');
            
            if (totalRows) totalRows.textContent = this.excelData.length;
            if (totalColumns) totalColumns.textContent = this.availableColumns.length;
            if (cityColumn) cityColumn.textContent = this.selectedColumns.length || '-';
            if (dataStats) dataStats.style.display = 'block';
        }

        displayPreview() {
            const results = document.getElementById('results');
            const dataPreview = document.getElementById('dataPreview');
            
            if (!results || !dataPreview || !this.excelData.length) return;

            const previewData = this.filteredData.length > 0 ? this.filteredData : this.excelData;
            const displayData = previewData.slice(0, 5);
            
            let html = '<div class="table-container"><table class="table"><thead><tr>';
            
            this.availableColumns.forEach(header => {
                const isSelected = this.selectedColumns.includes(header);
                const style = isSelected ? 'background: #FF9800; color: white;' : 'background: #ccc;';
                html += `<th style="${style}">${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            displayData.forEach(row => {
                html += '<tr>';
                this.availableColumns.forEach(header => {
                    const value = row[header] || '';
                    const isSelected = this.selectedColumns.includes(header);
                    const style = isSelected ? 'background: #fff3e0; font-weight: bold;' : 'background: #f5f5f5;';
                    html += `<td style="${style}" title="${value}">${value.length > 50 ? value.substring(0, 47) + '...' : value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += `<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                ğŸ“‹ æ˜¾ç¤ºå‰ ${displayData.length} è¡Œæ•°æ®ï¼Œå…± ${previewData.length} è¡Œ
            </div>`;
            
            dataPreview.innerHTML = html;
            results.style.display = 'block';
        }

        handleFilter() {
            const cityInput = document.getElementById('cityInput');
            const searchValue = cityInput ? cityInput.value.trim() : '';
            
            if (!searchValue) {
                this.showStatus('filterStatus', 'è¯·è¾“å…¥è¦ç­›é€‰çš„å€¼ï¼', 'error');
                return;
            }
            
            if (!this.selectedColumns.length) {
                this.showStatus('filterStatus', 'è¯·å…ˆé€‰æ‹©è¦ç­›é€‰çš„åˆ—ï¼', 'error');
                return;
            }
            
            // è·å–åŒ¹é…æ¨¡å¼
            const matchModeRadio = document.querySelector('input[name="matchMode"]:checked');
            const matchMode = matchModeRadio ? matchModeRadio.value : 'exact';
            
            // è·å–æ˜¯å¦å¯ç”¨å¤šé¡¹æœç´¢
            const multiSearchCheckbox = document.getElementById('multiSearch');
            const isMultiSearch = multiSearchCheckbox ? multiSearchCheckbox.checked : false;
            
            // è·å–é€»è¾‘æ¨¡å¼
            const logicModeRadio = document.querySelector('input[name="logicMode"]:checked');
            const logicMode = logicModeRadio ? logicModeRadio.value : 'or';
            
            // å¤„ç†æœç´¢è¯ - æ”¯æŒä¸­è‹±æ–‡é€—å·
            let searchTerms = [];
            if (isMultiSearch) {
                // å¤šé¡¹æœç´¢ï¼šæ”¯æŒä¸­æ–‡é€—å·ï¼ˆï¼Œï¼‰å’Œè‹±æ–‡é€—å·ï¼ˆ,ï¼‰
                searchTerms = searchValue
                    .split(/[,ï¼Œ]/)  // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒæ—¶åŒ¹é…ä¸­è‹±æ–‡é€—å·
                    .map(term => term.trim())
                    .filter(term => term.length > 0);
                
                if (searchTerms.length === 0) {
                    this.showStatus('filterStatus', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æœç´¢è¯ï¼', 'error');
                    return;
                }
                
                console.log('ğŸ” æ£€æµ‹åˆ°çš„æœç´¢è¯:', searchTerms);
            } else {
                // å•é¡¹æœç´¢
                searchTerms = [searchValue];
            }
            
            console.log('ğŸ” æœç´¢å‚æ•°:', { matchMode, isMultiSearch, searchTerms, logicMode });
            
            // æ‰§è¡Œç­›é€‰
            this.filteredData = this.excelData.filter(row => {
                return this.selectedColumns.some(column => {
                    const cellValue = row[column];
                    if (!cellValue) return false;
                    
                    const cellStr = cellValue.toString();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»æ„ä¸€ä¸ªæœç´¢è¯
                    return searchTerms.some(searchTerm => {
                        return this.matchValue(cellStr, searchTerm, matchMode);
                    });
                });
            });
            
            // æ ¹æ®é€»è¾‘æ¨¡å¼è¿›ä¸€æ­¥ç­›é€‰
            if (logicMode === 'and' && this.filteredData.length > 0) {
                this.filteredData = this.filteredData.filter(row => {
                    return searchTerms.every(searchTerm => {
                        return this.selectedColumns.some(column => {
                            const cellValue = row[column];
                            return cellValue && this.matchValue(cellValue.toString(), searchTerm, matchMode);
                        });
                    });
                });
            }
            
            // æ˜¾ç¤ºç»“æœ
            if (this.filteredData.length > 0) {
                const modeDescriptions = {
                    'exact': 'ç²¾ç¡®åŒ¹é…ï¼ˆå®Œå…¨ç›¸ç­‰ï¼‰',
                    'exactIgnoreCase': 'ç²¾ç¡®åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰',
                    'contains': 'åŒ…å«åŒ¹é…ï¼ˆå¹¿ä¹‰æœç´¢ï¼‰',
                    'containsIgnoreCase': 'åŒ…å«åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰'
                };
                
                const searchDescription = isMultiSearch ? 
                    `å¤šé¡¹æœç´¢ï¼š${searchTerms.join('ã€')}` : 
                    `å•é¡¹æœç´¢ï¼š${searchValue}`;
                
                const logicDescription = logicMode === 'and' ? 'å¹¶ä¸”' : 'æˆ–è€…';
                
                this.showStatus('filterStatus', 
                    `ğŸ‰ ç­›é€‰å®Œæˆï¼æ‰¾åˆ° ${this.filteredData.length} æ¡æ•°æ®\n\n` +
                    `${searchDescription}\n` +
                    `åŒ¹é…æ¨¡å¼ï¼š${modeDescriptions[matchMode]}\n` +
                    `é€»è¾‘æ¨¡å¼ï¼š${logicDescription}\n` +
                    `ç­›é€‰åˆ—ï¼š${this.selectedColumns.join('ã€')}`, 
                    'success'
                );
                this.displayPreview();
            } else {
                this.showStatus('filterStatus', 
                    `ğŸ˜” æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®ï¼\n\n` +
                    `æœç´¢è¯ï¼š${searchTerms.join('ã€')}\n` +
                    `åŒ¹é…æ¨¡å¼ï¼š${modeDescriptions[matchMode] || matchMode}\n` +
                    `å·²æœç´¢åˆ—ï¼š${this.selectedColumns.join('ã€')}`, 
                    'error'
                );
            }
        }

        // æ·»åŠ åŒ¹é…å€¼çš„æ–¹æ³•
        matchValue(cellValue, searchTerm, matchMode) {
            switch (matchMode) {
                case 'exact':
                    return cellValue.trim() === searchTerm.trim();
                case 'exactIgnoreCase':
                    return cellValue.trim().toLowerCase() === searchTerm.trim().toLowerCase();
                case 'contains':
                    return cellValue.includes(searchTerm);
                case 'containsIgnoreCase':
                    return cellValue.toLowerCase().includes(searchTerm.toLowerCase());
                default:
                    return cellValue.trim() === searchTerm.trim();
            }
        }

        clearFilter() {
            this.filteredData = [];
            const cityInput = document.getElementById('cityInput');
            if (cityInput) {
                cityInput.value = '';
                cityInput.placeholder = 'è¾“å…¥æœç´¢è¯ï¼Œå¤šä¸ªè¯ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šåŒ—äº¬,ä¸Šæµ·,å¹¿å·';
            }
            this.displayPreview();
            this.showStatus('filterStatus', 'ç­›é€‰å·²æ¸…é™¤', 'info');
        }

        showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.className = 'status ' + (type || 'info');
            statusElement.innerHTML = message;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        async readFileAsTextWithEncoding(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = (e) => {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file, encoding);
            });
        }

        async readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = (e) => {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsText(file);
            });
        }

        async readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    resolve(arrayBuffer);
                };
                reader.onerror = (e) => {
                    reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        hasGarbledText(text) {
            // ç®€å•çš„ä¹±ç æ£€æµ‹ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§çš„ä¹±ç å­—ç¬¦
            const garbledPatterns = [/[\uFFFD\u202E\u202C]/, /[\uD800-\uDFFF]/, /[\uDC00-\uDC7F]/];
            return garbledPatterns.some(pattern => pattern.test(text));
        }

        downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        exportCSV() {
            if (!this.filteredData.length) {
                this.showStatus('exportStatus', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            const csvRows = [];
            const headers = this.selectedColumns;
            csvRows.push(headers.join(','));

            this.filteredData.forEach(row => {
                const values = headers.map(header => {
                    const escaped = (row[header] || '').toString().replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const defaultFilename = `export-${timestamp}.csv`;
            const filenameInput = document.getElementById('filenameInput');
            const filename = (filenameInput && filenameInput.value.trim()) || defaultFilename;

            this.downloadFile(filename, csvContent);
            this.showStatus('exportStatus', `æ•°æ®å·²å¯¼å‡ºä¸º CSV æ–‡ä»¶ï¼š${filename}`, 'success');
        }

        exportExcel() {
            if (!this.filteredData.length) {
                this.showStatus('exportStatus', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            const wsData = [];

            // æ·»åŠ è¡¨å¤´
            const headerRow = this.selectedColumns.map(col => ({ v: col, s: { fill: { fgColor: { rgb: "FF9800" } } } }));
            wsData.push(headerRow);

            // æ·»åŠ æ•°æ®è¡Œ
            this.filteredData.forEach(row => {
                const rowData = this.selectedColumns.map(col => ({ v: row[col] || '' }));
                wsData.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const defaultFilename = `export-${timestamp}.xlsx`;
            const filenameInput = document.getElementById('filenameInput');
            const filename = (filenameInput && filenameInput.value.trim()) || defaultFilename;

            XLSX.writeFile(wb, filename);
            this.showStatus('exportStatus', `æ•°æ®å·²å¯¼å‡ºä¸º Excel æ–‡ä»¶ï¼š${filename}`, 'success');
        }
    }

    window.excelApp = new EnhancedExcelManager();
    </script>
</body>
</html>