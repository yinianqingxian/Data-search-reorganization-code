<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 数据管理器 - 浏览器版</title>
    <!-- 修复CSS路径 -->
    <link rel="stylesheet" href="src/renderer/styles/main.css">
    <style>
        /* 内嵌关键样式以防外部CSS加载失败 */
        .status { padding: 12px; margin: 15px 0; border-radius: 6px; display: none; font-weight: 500; line-height: 1.5; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button:disabled { background: #ccc !important; cursor: not-allowed; }
        
        /* 多选列选择器样式 */
        .column-selector { margin-bottom: 15px; display: none; }
        .column-selector h3 { margin-bottom: 15px; color: #333; }
        .column-section { margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .recommended-section { background: #e8f5e8; border: 1px solid #4CAF50; }
        .all-columns-section { background: #f9f9f9; border: 1px solid #ddd; }
        .control-buttons { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .checkbox-container { display: flex; align-items: center; gap: 8px; padding: 6px; border-radius: 4px; transition: background-color 0.2s; margin-bottom: 8px; }
        .checkbox-container:hover { background-color: #f0f0f0; }
        .checkbox-container input[type="checkbox"] { width: 16px; height: 16px; }
        .checkbox-container label { cursor: pointer; flex: 1; font-size: 14px; line-height: 1.4; }
        .category-group { margin-bottom: 15px; }
        .category-label { font-weight: bold; color: #555; margin-bottom: 8px; font-size: 14px; }
        .columns-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-left: 15px; }
        
        /* 表格容器样式 */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* 修复表格样式 */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .table th,
        .table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
            font-size: 14px;
        }
        
        .table th {
            background: #4CAF50;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .table tr:hover {
            background: #e8f5e8;
        }
        
        .table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 计算器样式 */
        .calc-select, .calc-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 100%;
        }

        .calc-select:focus, .calc-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
        }

        .calc-section {
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e5e5e5;
        }

        .calculator-content {
            max-width: 100%;
        }

        .calculator-content input[type="radio"] + span {
            padding: 0.25rem 0;
        }

        .calculator-content label:has(input[type="radio"]:checked) {
            background: #f0f9ff;
            border-color: #0ea5e9;
            color: #0369a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Excel 数据管理器</h1>
            <p>浏览器版 - 上传 Excel/CSV 文件，选择筛选列，按条件筛选数据，一键导出结果</p>
        </div>
        
        <div class="content">
            <!-- 文件上传组件 -->
            <div class="section">
                <h2>📁 第一步：上传数据文件</h2>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                <p class="help-text">支持 Excel (.xlsx, .xls) 和 CSV 文件格式，支持拖拽上传</p>
                <div id="fileStatus" class="status"></div>
                <div id="fileInfo" class="file-info" style="display: none;">
                    <strong>文件信息：</strong>
                    <div id="fileDetails"></div>
                </div>
                <div id="dataStats" class="data-stats" style="display: none;">
                    <strong>📈 数据概览</strong>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div id="totalRows" class="stat-number">0</div>
                            <div class="stat-label">总行数</div>
                        </div>
                        <div class="stat-item">
                            <div id="totalColumns" class="stat-number">0</div>
                            <div class="stat-label">总列数</div>
                        </div>
                        <div class="stat-item">
                            <div id="cityColumn" class="stat-number">-</div>
                            <div class="stat-label">筛选列</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据筛选组件 -->
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>🔍 第二步：选择筛选列并筛选数据</h2>
                    <button id="calcToggleBtn" class="button secondary" style="font-size: 0.875rem;">
                        🧮 列计算器
                    </button>
                </div>
                
                <!-- 多选列选择器 -->
                <div id="columnSelector" class="column-selector">
                    <!-- 动态生成的内容会插入这里 -->
                </div>
                
                <!-- 匹配模式选择 -->
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #e0e8f0;">
                    <label style="font-weight: bold; color: #333; margin-bottom: 8px; display: block;">🎯 匹配模式：</label>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="exact" checked>
                            <span>精确匹配（完全相等）</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="exactIgnoreCase">
                            <span>精确匹配（忽略大小写）</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="contains">
                            <span>包含匹配（广义搜索）</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="radio" name="matchMode" value="containsIgnoreCase">
                            <span>包含匹配（忽略大小写）</span>
                        </label>
                    </div>
                </div>
                
                <!-- 逻辑模式选择器 - 只在多项搜索启用时显示 -->
                <div style="margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="multiSearch" checked>
                        <span style="font-weight: bold; color: #4CAF50;">🔍 多项搜索（用逗号分隔多个搜索词）</span>
                    </label>
                    
                    <!-- 逻辑模式选择器 - 嵌套在多项搜索下面 -->
                    <div id="logicModeSelector" style="margin-top: 8px; margin-left: 25px; padding: 8px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; display: block;">
                        <label style="font-weight: bold; color: #333; margin-bottom: 5px; display: block;">🔗 多项搜索逻辑：</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="logicMode" value="or" checked>
                                <span>OR模式（任一条件满足）</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="logicMode" value="and">
                                <span>AND模式（所有条件都要满足）</span>
                            </label>
                        </div>
                        <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
                            💡 OR模式：搜索"北京,上海"时，包含北京或上海的数据都会显示<br>
                            💡 AND模式：搜索"北京,2023"时，同时包含北京和2023的数据才会显示
                        </p>
                    </div>
                </div>
                
                <p style="font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 0;">
                    💡 <strong>使用说明：</strong><br>
                    • 精确匹配：输入值必须与数据完全一致<br>
                    • 包含匹配：数据中包含输入值即可匹配<br>
                    • 多项搜索：用逗号分隔，支持中英文逗号，如"北京,上海,广州"或"北京，上海，广州"<br><br>
                </p>
                
                <!-- 筛选输入 -->
                <input type="text" id="cityInput" class="text-input" placeholder="输入搜索词，多个词用逗号分隔（支持中英文逗号），如：北京,上海,广州 或 北京，上海，广州" disabled><br><br>
                <button id="filterBtn" class="button" disabled>🔍 智能筛选</button>
                <button id="clearFilterBtn" class="button secondary" disabled>🗑️ 清除筛选</button>
                <div id="filterStatus" class="status"></div>
            </div>

            <!-- 列计算器 -->
            <div id="columnCalculator" class="section" style="display: none;">
                <h2>🧮 列计算器</h2>
                <div class="calculator-content">
                    <!-- 计算类型选择 -->
                    <div class="calc-type-selector" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">计算类型：</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="radio" name="calcType" value="numeric" checked>
                                <span>数值计算</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="radio" name="calcType" value="text">
                                <span>文本操作</span>
                            </label>
                        </div>
                    </div>

                    <!-- 数值计算区域 -->
                    <div id="numericCalc" class="calc-section">
                        <div class="calc-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">列A：</label>
                                <select id="columnA" class="calc-select">
                                    <option value="">选择列</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">
                                <span id="operationSymbol">+</span>
                            </div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">列B：</label>
                                <select id="columnB" class="calc-select">
                                    <option value="">选择列</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">=</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">新列名：</label>
                                <input type="text" id="newColumnName" class="calc-input" placeholder="输入新列名">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">运算类型：</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="add" checked>
                                    <span>加法 (+)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="subtract">
                                    <span>减法 (-)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="multiply">
                                    <span>乘法 (×)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="divide">
                                    <span>除法 (÷)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; transition: all 0.2s;">
                                    <input type="radio" name="operation" value="percentage">
                                    <span>百分比 (%)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 文本操作区域 -->
                    <div id="textCalc" class="calc-section" style="display: none;">
                        <div class="calc-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">列A：</label>
                                <select id="textColumnA" class="calc-select">
                                    <option value="">选择列</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">+</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">列B：</label>
                                <select id="textColumnB" class="calc-select">
                                    <option value="">选择列</option>
                                </select>
                            </div>
                            
                            <div style="text-align: center; font-size: 1.5rem; font-weight: bold; color: #666;">=</div>
                            
                            <div>
                                <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">新列名：</label>
                                <input type="text" id="textNewColumnName" class="calc-input" placeholder="输入新列名">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">连接符（可选）：</label>
                            <input type="text" id="textSeparator" class="calc-input" placeholder="如：-, _, 空格等" style="max-width: 200px;">
                            <div class="help-text">留空则直接连接，输入符号则在两列之间插入</div>
                        </div>
                    </div>

                    <!-- 预览区域 -->
                    <div id="calcPreview" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 0.5rem;">📋 计算预览（前5行）</h4>
                        <div id="previewTable"></div>
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                        <button id="previewCalcBtn" class="button secondary">👁️ 预览计算</button>
                        <button id="executeCalcBtn" class="button" disabled>✅ 执行计算</button>
                        <button id="clearCalcBtn" class="button secondary">🗑️ 清除</button>
                    </div>

                    <!-- 已有计算列管理 -->
                    <div id="existingCalcColumns" style="margin-top: 1.5rem; display: none;">
                        <h4>📊 已创建的计算列</h4>
                        <div id="calcColumnsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- 数据导出组件 -->
            <div class="section">
                <h2>📤 第三步：导出数据</h2>
                <div class="export-options">
                    <input type="text" id="filenameInput" class="filename-input" placeholder="输入文件名（不含扩展名）">
                    <button id="exportCSVBtn" class="button" disabled>💾 导出 CSV</button>
                    <button id="exportExcelBtn" class="button secondary" disabled>📊 导出 Excel兼容</button>
                </div>
                <div id="exportStatus" class="status"></div>
            </div>
            
            <!-- 数据预览 -->
            <div id="results" class="results" style="display: none;">
                <h3>📋 数据预览</h3>
                <div id="dataPreview"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
    console.log('🚀 开始加载完整功能...');

    // 检查XLSX库
    if (typeof XLSX === 'undefined') {
        alert('XLSX库加载失败，请刷新页面重试');
    }

    // 简化的ExcelManager类 - 增强版
    class EnhancedExcelManager {
        constructor() {
            this.excelData = [];
            this.filteredData = [];
            this.selectedColumns = [];
            this.availableColumns = [];
            this.calculatedColumns = new Map(); // 存储计算列的定义
            this.operationTypes = {
                'add': { label: '加法 (+)', symbol: '+', operation: (a, b) => a + b },
                'subtract': { label: '减法 (-)', symbol: '-', operation: (a, b) => a - b },
                'multiply': { label: '乘法 (×)', symbol: '×', operation: (a, b) => a * b },
                'divide': { label: '除法 (÷)', symbol: '÷', operation: (a, b) => b !== 0 ? a / b : '除零错误' },
                'percentage': { label: '百分比 (A/B×100)', symbol: '%', operation: (a, b) => b !== 0 ? (a / b * 100).toFixed(2) + '%' : '除零错误' }
            };
            
            this.init();
        }

        init() {
            console.log('🚀 初始化增强版Excel管理器...');
            
            // 多项搜索复选框事件
            const multiSearchCheckbox = document.getElementById('multiSearch');
            const logicModeSelector = document.getElementById('logicModeSelector');
            
            if (multiSearchCheckbox && logicModeSelector) {
                const updateLogicModeVisibility = () => {
                    logicModeSelector.style.display = multiSearchCheckbox.checked ? 'block' : 'none';
                };
                
                updateLogicModeVisibility();
                multiSearchCheckbox.addEventListener('change', updateLogicModeVisibility);
                console.log('✅ 多项搜索和逻辑模式选择器事件绑定成功');
            }
            
            this.bindEvents();
            this.initCalculator();
        }

        initCalculator() {
            // 计算器切换按钮
            const calcToggleBtn = document.getElementById('calcToggleBtn');
            if (calcToggleBtn) {
                calcToggleBtn.addEventListener('click', () => this.toggleCalculator());
            }

            // 计算类型切换
            document.querySelectorAll('input[name="calcType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const numericCalc = document.getElementById('numericCalc');
                    const textCalc = document.getElementById('textCalc');
                    
                    if (e.target.value === 'numeric') {
                        numericCalc.style.display = 'block';
                        textCalc.style.display = 'none';
                    } else {
                        numericCalc.style.display = 'none';
                        textCalc.style.display = 'block';
                    }
                    this.clearPreview();
                });
            });

            // 运算类型切换
            document.querySelectorAll('input[name="operation"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const symbol = this.operationTypes[e.target.value].symbol;
                    document.getElementById('operationSymbol').textContent = symbol;
                    this.clearPreview();
                });
            });

            // 预览和执行按钮
            document.getElementById('previewCalcBtn').addEventListener('click', () => this.previewCalculation());
            document.getElementById('executeCalcBtn').addEventListener('click', () => this.executeCalculation());
            document.getElementById('clearCalcBtn').addEventListener('click', () => this.clearCalculator());
        }

        bindEvents() {
            // 文件上传事件
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    console.log('📁 文件change事件触发');
                    this.handleFileUpload(e);
                });
                console.log('✅ 文件上传事件绑定成功');
            }

            // 筛选按钮
            const filterBtn = document.getElementById('filterBtn');
            if (filterBtn) {
                filterBtn.addEventListener('click', () => this.handleFilter());
            }

            // 清除筛选按钮
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener('click', () => this.clearFilter());
            }

            // 导出按钮
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', () => this.exportCSV());
            }

            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => this.exportExcel());
            }
        }

        // 显示/隐藏计算器
        toggleCalculator() {
            const calculator = document.getElementById('columnCalculator');
            if (calculator) {
                const isVisible = calculator.style.display !== 'none';
                calculator.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    this.updateCalculatorOptions();
                }
            }
        }

        // 更新计算器选项
        updateCalculatorOptions() {
            const { numericColumns, allColumns } = this.getAvailableColumns();
            
            console.log('🔄 更新计算器选项:', { 
                数值列: numericColumns, 
                所有列: allColumns 
            });
            
            const updateSelect = (selectId, columns) => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">选择列</option>' + 
                        columns.map(col => {
                            // 为计算列添加标识
                            const isCalculated = this.calculatedColumns.has(col);
                            const label = isCalculated ? `🧮 ${col} (计算列)` : `📄 ${col}`;
                            return `<option value="${col}">${label}</option>`;
                        }).join('');
                    
                    // 恢复之前选择的值（如果仍然可用）
                    if (columns.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }
            };

            updateSelect('columnA', numericColumns);
            updateSelect('columnB', numericColumns);
            updateSelect('textColumnA', allColumns);
            updateSelect('textColumnB', allColumns);
        }

        // 获取可用于计算的列
        getAvailableColumns() {
            const numericColumns = [];
            const allColumns = [...this.availableColumns]; // 开始时包含所有原始列

            // 添加已计算的列
            this.calculatedColumns.forEach((definition, columnName) => {
                if (!allColumns.includes(columnName)) {
                    allColumns.push(columnName);
                }
            });

            // 检查哪些列是数值列
            allColumns.forEach(column => {
                if (this.isNumericColumn(column)) {
                    numericColumns.push(column);
                }
            });

            console.log('📊 可用列更新:', { 
                原始列: this.availableColumns.length, 
                计算列: this.calculatedColumns.size, 
                总列数: allColumns.length, 
                数值列: numericColumns.length 
            });

            return { numericColumns, allColumns };
        }

        // 判断列是否为数值列
        isNumericColumn(columnName) {
            // 如果是计算列，根据其定义判断类型
            if (this.calculatedColumns.has(columnName)) {
                const definition = this.calculatedColumns.get(columnName);
                return definition.type === 'numeric';
            }
            
            // 原始列的数值检测
            const sampleData = this.excelData.slice(0, Math.min(10, this.excelData.length));
            if (sampleData.length === 0) return false;
            
            let numericCount = 0;
            
            for (const row of sampleData) {
                const value = row[columnName];
                if (value !== null && value !== undefined && value !== '') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        numericCount++;
                    }
                }
            }
            
            return numericCount > sampleData.length * 0.5;
        }

        // 预览计算结果
        previewCalculation() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            
            if (calcType === 'numeric') {
                this.previewNumericCalculation();
            } else {
                this.previewTextCalculation();
            }
        }

        // 预览数值计算
        previewNumericCalculation() {
            const columnA = document.getElementById('columnA').value;
            const columnB = document.getElementById('columnB').value;
            const newColumnName = document.getElementById('newColumnName').value.trim();
            const operation = document.querySelector('input[name="operation"]:checked').value;

            if (!columnA || !columnB || !newColumnName) {
                alert('请选择两个列并输入新列名');
                return;
            }

            if (this.availableColumns.includes(newColumnName) || this.calculatedColumns.has(newColumnName)) {
                alert('列名已存在，请使用其他名称');
                return;
            }

            const preview = this.generateNumericPreview(columnA, columnB, newColumnName, operation);
            this.showPreview(preview);
        }

        // 预览文本操作
        previewTextCalculation() {
            const columnA = document.getElementById('textColumnA').value;
            const columnB = document.getElementById('textColumnB').value;
            const newColumnName = document.getElementById('textNewColumnName').value.trim();
            const separator = document.getElementById('textSeparator').value;

            if (!columnA || !columnB || !newColumnName) {
                alert('请选择两个列并输入新列名');
                return;
            }

            if (this.availableColumns.includes(newColumnName) || this.calculatedColumns.has(newColumnName)) {
                alert('列名已存在，请使用其他名称');
                return;
            }

            const preview = this.generateTextPreview(columnA, columnB, newColumnName, separator);
            this.showPreview(preview);
        }

        // 生成数值计算预览
        generateNumericPreview(columnA, columnB, newColumnName, operation) {
            const operationFunc = this.operationTypes[operation].operation;
            const previewData = this.excelData.slice(0, 5);
            
            return previewData.map(row => {
                const valueA = this.getNumericValue(row[columnA]);
                const valueB = this.getNumericValue(row[columnB]);
                const result = operationFunc(valueA, valueB);
                
                return {
                    [columnA]: row[columnA],
                    [columnB]: row[columnB],
                    [newColumnName]: result
                };
            });
        }

        // 生成文本操作预览
        generateTextPreview(columnA, columnB, newColumnName, separator = '') {
            const previewData = this.excelData.slice(0, 5);
            
            return previewData.map(row => {
                const valueA = (row[columnA] || '').toString();
                const valueB = (row[columnB] || '').toString();
                const result = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
                
                return {
                    [columnA]: row[columnA],
                    [columnB]: row[columnB],
                    [newColumnName]: result
                };
            });
        }

        // 显示预览
        showPreview(previewData) {
            const previewContainer = document.getElementById('calcPreview');
            const previewTable = document.getElementById('previewTable');
            
            if (previewData.length === 0) {
                previewTable.innerHTML = '<p>没有数据可预览</p>';
                previewContainer.style.display = 'block';
                return;
            }

            const columns = Object.keys(previewData[0]);
            let html = '<table class="table" style="font-size: 0.875rem;"><thead><tr>';
            
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            previewTable.innerHTML = html;
            previewContainer.style.display = 'block';
            
            // 启用执行按钮
            document.getElementById('executeCalcBtn').disabled = false;
        }

        // 执行计算
        executeCalculation() {
            const calcType = document.querySelector('input[name="calcType"]:checked').value;
            
            if (calcType === 'numeric') {
                this.executeNumericCalculation();
            } else {
                this.executeTextCalculation();
            }
        }

        // 执行数值计算
        executeNumericCalculation() {
            const columnA = document.getElementById('columnA').value;
            const columnB = document.getElementById('columnB').value;
            const newColumnName = document.getElementById('newColumnName').value.trim();
            const operation = document.querySelector('input[name="operation"]:checked').value;

            const operationFunc = this.operationTypes[operation].operation;
            
            // 为所有数据添加新列
            this.excelData.forEach(row => {
                const valueA = this.getNumericValue(row[columnA]);
                const valueB = this.getNumericValue(row[columnB]);
                row[newColumnName] = operationFunc(valueA, valueB);
            });

            // 如果有筛选数据，也要更新
            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    const valueA = this.getNumericValue(row[columnA]);
                    const valueB = this.getNumericValue(row[columnB]);
                    row[newColumnName] = operationFunc(valueA, valueB);
                });
            }

            // 记录计算列定义
            this.calculatedColumns.set(newColumnName, {
                type: 'numeric',
                columnA,
                columnB,
                operation,
                formula: `${columnA} ${this.operationTypes[operation].symbol} ${columnB}`
            });

            this.completeCalculation(newColumnName);
        }

        // 执行文本操作
        executeTextCalculation() {
            const columnA = document.getElementById('textColumnA').value;
            const columnB = document.getElementById('textColumnB').value;
            const newColumnName = document.getElementById('textNewColumnName').value.trim();
            const separator = document.getElementById('textSeparator').value;

            // 为所有数据添加新列
            this.excelData.forEach(row => {
                const valueA = (row[columnA] || '').toString();
                const valueB = (row[columnB] || '').toString();
                row[newColumnName] = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
            });

            // 如果有筛选数据，也要更新
            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    const valueA = (row[columnA] || '').toString();
                    const valueB = (row[columnB] || '').toString();
                    row[newColumnName] = separator ? `${valueA}${separator}${valueB}` : `${valueA}${valueB}`;
                });
            }

            // 记录计算列定义
            this.calculatedColumns.set(newColumnName, {
                type: 'text',
                columnA,
                columnB,
                separator,
                formula: separator ? `${columnA} + "${separator}" + ${columnB}` : `${columnA} + ${columnB}`
            });

            this.completeCalculation(newColumnName);
        }

        // 完成计算后的操作
        completeCalculation(newColumnName) {
            // 更新可用列列表
            if (!this.availableColumns.includes(newColumnName)) {
                this.availableColumns.push(newColumnName);
            }
            
            // 重新构建列选择器
            this.buildColumnSelector();
            
            // 更新数据统计
            this.showDataStats();
            
            // 更新预览
            this.displayPreview();
            
            // 💡 关键：更新计算器选项，让新列可以参与下次计算
            this.updateCalculatorOptions();
            
            // 更新已有计算列列表
            this.updateExistingCalculatedColumns();
            
            // 清除计算器输入
            this.clearCalculator();
            
            // 显示成功消息
            this.showStatus('filterStatus', 
                `🎉 计算列"${newColumnName}"创建成功！\n` +
                `公式：${this.calculatedColumns.get(newColumnName).formula}\n` +
                `✅ 已添加到数据表中，可以参与筛选、导出和下一步计算。`, 
                'success'
            );
        }

        // 更新已有计算列列表
        updateExistingCalculatedColumns() {
            const container = document.getElementById('existingCalcColumns');
            const list = document.getElementById('calcColumnsList');
            
            if (this.calculatedColumns.size === 0) {
                container.style.display = 'none';
                return;
            }

            let html = '<div style="display: grid; gap: 0.5rem;">';
            this.calculatedColumns.forEach((definition, columnName) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 0.25rem; border: 1px solid #e9ecef;">
                        <div>
                            <strong>${columnName}</strong>
                            <span style="margin-left: 0.5rem; color: #666; font-size: 0.875rem;">${definition.formula}</span>
                        </div>
                        <button onclick="window.excelApp.removeCalculatedColumn('${columnName}')" 
                                class="button secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">删除</button>
                    </div>
                `;
            });
            html += '</div>';
            
            list.innerHTML = html;
            container.style.display = 'block';
        }

        // 删除计算列
        removeCalculatedColumn(columnName) {
            if (!confirm(`确定要删除计算列"${columnName}"吗？`)) {
                return;
            }

            // 从数据中移除该列
            this.excelData.forEach(row => {
                delete row[columnName];
            });

            if (this.filteredData.length > 0) {
                this.filteredData.forEach(row => {
                    delete row[columnName];
                });
            }

            // 从可用列中移除
            this.availableColumns = this.availableColumns.filter(col => col !== columnName);
            
            // 从选中列中移除
            this.selectedColumns = this.selectedColumns.filter(col => col !== columnName);
            
            // 删除计算列定义
            this.calculatedColumns.delete(columnName);
            
            // 更新界面
            this.buildColumnSelector();
            this.displayPreview();
            this.updateExistingCalculatedColumns();
            
            this.showStatus('filterStatus', `计算列"${columnName}"已删除`, 'info');
        }

        // 获取数值
        getNumericValue(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        // 清除预览
        clearPreview() {
            document.getElementById('calcPreview').style.display = 'none';
            document.getElementById('executeCalcBtn').disabled = true;
        }

        // 清除计算器
        clearCalculator() {
            document.getElementById('columnA').value = '';
            document.getElementById('columnB').value = '';
            document.getElementById('newColumnName').value = '';
            document.getElementById('textColumnA').value = '';
            document.getElementById('textColumnB').value = '';
            document.getElementById('textNewColumnName').value = '';
            document.getElementById('textSeparator').value = '';
            
            // 重置为加法
            document.querySelector('input[name="operation"][value="add"]').checked = true;
            document.getElementById('operationSymbol').textContent = '+';
            
            this.clearPreview();
        }

        // 文件上传完成后
        onFileLoaded() {
            // 显示计算器
            const calculator = document.getElementById('columnCalculator');
            if (calculator) {
                this.updateCalculatorOptions();
            }
        }

        // 以下是原有的方法，保持不变...
        async handleFileUpload(event) {
            console.log('🎯 处理文件上传...');
            
            const file = event.target.files[0];
            if (!file) {
                console.log('❌ 没有选择文件');
                return;
            }

            console.log('📁 文件信息:', file.name, file.size, file.type);

            // 显示处理状态
            this.showStatus('fileStatus', '📋 正在处理文件...', 'info');

            // 重置数据
            this.excelData = [];
            this.filteredData = [];
            this.selectedColumns = [];
            this.availableColumns = [];

            try {
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.csv')) {
                    console.log('📄 处理CSV文件');
                    await this.handleCSVFile(file);
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    console.log('📊 处理Excel文件');
                    await this.handleExcelFile(file);
                } else {
                    this.showStatus('fileStatus', '❌ 不支持的文件格式！\n支持: .xlsx, .xls, .csv', 'error');
                }
            } catch (error) {
                console.error('❌ 文件处理失败:', error);
                this.showStatus('fileStatus', `❌ 文件处理失败: ${error.message}`, 'error');
            }
        }

        async handleCSVFile(file) {
            try {
                console.log('📄 开始处理CSV文件，尝试多种编码...');
                
                // 尝试多种编码
                const encodings = ['UTF-8', 'GBK', 'GB2312', 'GB18030'];
                let text = null;
                let usedEncoding = 'UTF-8';
                
                for (const encoding of encodings) {
                    try {
                        console.log(`🔍 尝试 ${encoding} 编码...`);
                        text = await this.readFileAsTextWithEncoding(file, encoding);
                        
                        // 简单的乱码检测
                        if (text && !this.hasGarbledText(text)) {
                            usedEncoding = encoding;
                            console.log(`✅ ${encoding} 编码成功`);
                            break;
                        }
                    } catch (error) {
                        console.log(`❌ ${encoding} 编码失败:`, error.message);
                    }
                }
                
                if (!text) {
                    // 最后尝试浏览器自动检测
                    console.log('🔍 尝试浏览器自动检测编码...');
                    text = await this.readFileAsText(file);
                    usedEncoding = '自动检测';
                }
                
                if (!text) {
                    throw new Error('无法读取文件内容');
                }
                
                console.log(`📄 使用 ${usedEncoding} 编码读取成功，内容长度:`, text.length);
                this.parseCSVData(text, file.name);
                
            } catch (error) {
                throw new Error(`CSV读取失败: ${error.message}`);
            }
        }

        async handleExcelFile(file) {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excel处理库未加载');
                }

                const arrayBuffer = await this.readFileAsArrayBuffer(file);
                console.log('📊 Excel文件读取成功，大小:', arrayBuffer.byteLength);
                
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                console.log('📊 工作表:', workbook.SheetNames);
                
                if (!workbook.SheetNames.length) {
                    throw new Error('Excel文件中没有工作表');
                }

                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                
                if (jsonData.length < 2) {
                    throw new Error('Excel文件中没有足够的数据');
                }

                // 处理数据
                const headers = jsonData[0].filter(h => h && h.toString().trim());
                const dataRows = jsonData.slice(1).filter(row => 
                    row.some(cell => cell && cell.toString().trim())
                );

                this.excelData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] ? row[index].toString() : '';
                    });
                    return obj;
                });

                this.availableColumns = headers;
                
                this.showStatus('fileStatus', 
                    `✅ Excel文件处理成功！\n文件: ${file.name}\n数据: ${this.excelData.length} 行，${headers.length} 列`, 
                    'success'
                );
                
                this.buildColumnSelector();
                this.showDataStats();
                this.displayPreview();
                this.onFileLoaded(); // 文件加载完成后的回调

            } catch (error) {
                throw new Error(`Excel处理失败: ${error.message}`);
            }
        }

        parseCSVData(text, filename) {
            try {
                // 简单的CSV解析
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('CSV文件内容不足');
                }

                const headers = this.parseCSVLine(lines[0]);
                console.log('📄 CSV标题:', headers);

                this.excelData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = this.parseCSVLine(lines[i]);
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        this.excelData.push(row);
                    }
                }

                this.availableColumns = headers;
                
                this.showStatus('fileStatus', 
                    `✅ CSV文件处理成功！\n文件: ${filename}\n数据: ${this.excelData.length} 行，${headers.length} 列`, 
                    'success'
                );
                
                this.buildColumnSelector();
                this.showDataStats();
                this.displayPreview();
                this.onFileLoaded(); // 文件加载完成后的回调

            } catch (error) {
                throw new Error(`CSV解析失败: ${error.message}`);
            }
        }

        parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        buildColumnSelector() {
            const columnSelector = document.getElementById('columnSelector');
            if (!columnSelector || !this.availableColumns.length) return;

            let html = `
                <h3>🎯 选择要筛选的列 <span id="selectedCount">0</span> / ${this.availableColumns.length}</h3>
                <div style="margin-bottom: 15px;">
                    <button onclick="window.excelApp.selectAllColumns()" class="button">全选</button>
                    <button onclick="window.excelApp.clearAllColumns()" class="button secondary">清空</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            `;

            this.availableColumns.forEach(column => {
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" value="${column}" onchange="window.excelApp.toggleColumn('${column}')">
                        <span>📄 ${column}</span>
                    </label>
                `;
            });

            html += '</div>';
            columnSelector.innerHTML = html;
            columnSelector.style.display = 'block';
        }

        toggleColumn(column) {
            if (this.selectedColumns.includes(column)) {
                this.selectedColumns = this.selectedColumns.filter(col => col !== column);
            } else {
                this.selectedColumns.push(column);
            }
            this.updateSelectedCount();
            this.updateButtons();
        }

        selectAllColumns() {
            this.selectedColumns = [...this.availableColumns];
            this.updateCheckboxes();
            this.updateSelectedCount();
            this.updateButtons();
        }

        clearAllColumns() {
            this.selectedColumns = [];
            this.updateCheckboxes();
            this.updateSelectedCount();
            this.updateButtons();
        }

        updateCheckboxes() {
            const checkboxes = document.querySelectorAll('#columnSelector input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.selectedColumns.includes(checkbox.value);
            });
        }

        updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = this.selectedColumns.length;
            }
        }

        updateButtons() {
            const filterBtn = document.getElementById('filterBtn');
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const cityInput = document.getElementById('cityInput');

            const hasData = this.excelData.length > 0;
            const hasSelectedColumns = this.selectedColumns.length > 0;

            if (filterBtn) {
                filterBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (exportCSVBtn) {
                exportCSVBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (exportExcelBtn) {
                exportExcelBtn.disabled = !hasData || !hasSelectedColumns;
            }
            if (cityInput) {
                cityInput.disabled = !hasData || !hasSelectedColumns;
                
                if (hasSelectedColumns) {
                    cityInput.placeholder = `在所选 ${this.selectedColumns.length} 列中搜索（支持中英文逗号分隔）...`;
                } else {
                    cityInput.placeholder = '请先选择要筛选的列';
                }
            }
        }

        showDataStats() {
            const dataStats = document.getElementById('dataStats');
            const totalRows = document.getElementById('totalRows');
            const totalColumns = document.getElementById('totalColumns');
            const cityColumn = document.getElementById('cityColumn');
            
            if (totalRows) totalRows.textContent = this.excelData.length;
            if (totalColumns) totalColumns.textContent = this.availableColumns.length;
            if (cityColumn) cityColumn.textContent = this.selectedColumns.length || '-';
            if (dataStats) dataStats.style.display = 'block';
        }

        displayPreview() {
            const results = document.getElementById('results');
            const dataPreview = document.getElementById('dataPreview');
            
            if (!results || !dataPreview || !this.excelData.length) return;

            const previewData = this.filteredData.length > 0 ? this.filteredData : this.excelData;
            const displayData = previewData.slice(0, 5);
            
            let html = '<div class="table-container"><table class="table"><thead><tr>';
            
            this.availableColumns.forEach(header => {
                const isSelected = this.selectedColumns.includes(header);
                const style = isSelected ? 'background: #FF9800; color: white;' : 'background: #ccc;';
                html += `<th style="${style}">${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            displayData.forEach(row => {
                html += '<tr>';
                this.availableColumns.forEach(header => {
                    const value = row[header] || '';
                    const isSelected = this.selectedColumns.includes(header);
                    const style = isSelected ? 'background: #fff3e0; font-weight: bold;' : 'background: #f5f5f5;';
                    html += `<td style="${style}" title="${value}">${value.length > 50 ? value.substring(0, 47) + '...' : value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += `<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                📋 显示前 ${displayData.length} 行数据，共 ${previewData.length} 行
            </div>`;
            
            dataPreview.innerHTML = html;
            results.style.display = 'block';
        }

        handleFilter() {
            const cityInput = document.getElementById('cityInput');
            const searchValue = cityInput ? cityInput.value.trim() : '';
            
            if (!searchValue) {
                this.showStatus('filterStatus', '请输入要筛选的值！', 'error');
                return;
            }
            
            if (!this.selectedColumns.length) {
                this.showStatus('filterStatus', '请先选择要筛选的列！', 'error');
                return;
            }
            
            // 获取匹配模式
            const matchModeRadio = document.querySelector('input[name="matchMode"]:checked');
            const matchMode = matchModeRadio ? matchModeRadio.value : 'exact';
            
            // 获取是否启用多项搜索
            const multiSearchCheckbox = document.getElementById('multiSearch');
            const isMultiSearch = multiSearchCheckbox ? multiSearchCheckbox.checked : false;
            
            // 获取逻辑模式
            const logicModeRadio = document.querySelector('input[name="logicMode"]:checked');
            const logicMode = logicModeRadio ? logicModeRadio.value : 'or';
            
            // 处理搜索词 - 支持中英文逗号
            let searchTerms = [];
            if (isMultiSearch) {
                // 多项搜索：支持中文逗号（，）和英文逗号（,）
                searchTerms = searchValue
                    .split(/[,，]/)  // 使用正则表达式同时匹配中英文逗号
                    .map(term => term.trim())
                    .filter(term => term.length > 0);
                
                if (searchTerms.length === 0) {
                    this.showStatus('filterStatus', '请输入有效的搜索词！', 'error');
                    return;
                }
                
                console.log('🔍 检测到的搜索词:', searchTerms);
            } else {
                // 单项搜索
                searchTerms = [searchValue];
            }
            
            console.log('🔍 搜索参数:', { matchMode, isMultiSearch, searchTerms, logicMode });
            
            // 执行筛选
            this.filteredData = this.excelData.filter(row => {
                return this.selectedColumns.some(column => {
                    const cellValue = row[column];
                    if (!cellValue) return false;
                    
                    const cellStr = cellValue.toString();
                    
                    // 检查是否匹配任意一个搜索词
                    return searchTerms.some(searchTerm => {
                        return this.matchValue(cellStr, searchTerm, matchMode);
                    });
                });
            });
            
            // 根据逻辑模式进一步筛选
            if (logicMode === 'and' && this.filteredData.length > 0) {
                this.filteredData = this.filteredData.filter(row => {
                    return searchTerms.every(searchTerm => {
                        return this.selectedColumns.some(column => {
                            const cellValue = row[column];
                            return cellValue && this.matchValue(cellValue.toString(), searchTerm, matchMode);
                        });
                    });
                });
            }
            
            // 显示结果
            if (this.filteredData.length > 0) {
                const modeDescriptions = {
                    'exact': '精确匹配（完全相等）',
                    'exactIgnoreCase': '精确匹配（忽略大小写）',
                    'contains': '包含匹配（广义搜索）',
                    'containsIgnoreCase': '包含匹配（忽略大小写）'
                };
                
                const searchDescription = isMultiSearch ? 
                    `多项搜索：${searchTerms.join('、')}` : 
                    `单项搜索：${searchValue}`;
                
                const logicDescription = logicMode === 'and' ? '并且' : '或者';
                
                this.showStatus('filterStatus', 
                    `🎉 筛选完成！找到 ${this.filteredData.length} 条数据\n\n` +
                    `${searchDescription}\n` +
                    `匹配模式：${modeDescriptions[matchMode]}\n` +
                    `逻辑模式：${logicDescription}\n` +
                    `筛选列：${this.selectedColumns.join('、')}`, 
                    'success'
                );
                this.displayPreview();
            } else {
                this.showStatus('filterStatus', 
                    `😔 未找到匹配的数据！\n\n` +
                    `搜索词：${searchTerms.join('、')}\n` +
                    `匹配模式：${modeDescriptions[matchMode] || matchMode}\n` +
                    `已搜索列：${this.selectedColumns.join('、')}`, 
                    'error'
                );
            }
        }

        // 添加匹配值的方法
        matchValue(cellValue, searchTerm, matchMode) {
            switch (matchMode) {
                case 'exact':
                    return cellValue.trim() === searchTerm.trim();
                case 'exactIgnoreCase':
                    return cellValue.trim().toLowerCase() === searchTerm.trim().toLowerCase();
                case 'contains':
                    return cellValue.includes(searchTerm);
                case 'containsIgnoreCase':
                    return cellValue.toLowerCase().includes(searchTerm.toLowerCase());
                default:
                    return cellValue.trim() === searchTerm.trim();
            }
        }

        clearFilter() {
            this.filteredData = [];
            const cityInput = document.getElementById('cityInput');
            if (cityInput) {
                cityInput.value = '';
                cityInput.placeholder = '输入搜索词，多个词用逗号分隔，如：北京,上海,广州';
            }
            this.displayPreview();
            this.showStatus('filterStatus', '筛选已清除', 'info');
        }

        showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.className = 'status ' + (type || 'info');
            statusElement.innerHTML = message;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        async readFileAsTextWithEncoding(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = (e) => {
                    reject(new Error('文件读取失败'));
                };
                reader.readAsText(file, encoding);
            });
        }

        async readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    resolve(text);
                };
                reader.onerror = (e) => {
                    reject(new Error('文件读取失败'));
                };
                reader.readAsText(file);
            });
        }

        async readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    resolve(arrayBuffer);
                };
                reader.onerror = (e) => {
                    reject(new Error('文件读取失败'));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        hasGarbledText(text) {
            // 简单的乱码检测：检查是否包含常见的乱码字符
            const garbledPatterns = [/[\uFFFD\u202E\u202C]/, /[\uD800-\uDFFF]/, /[\uDC00-\uDC7F]/];
            return garbledPatterns.some(pattern => pattern.test(text));
        }

        downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        exportCSV() {
            if (!this.filteredData.length) {
                this.showStatus('exportStatus', '没有可导出的数据', 'error');
                return;
            }

            const csvRows = [];
            const headers = this.selectedColumns;
            csvRows.push(headers.join(','));

            this.filteredData.forEach(row => {
                const values = headers.map(header => {
                    const escaped = (row[header] || '').toString().replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const defaultFilename = `export-${timestamp}.csv`;
            const filenameInput = document.getElementById('filenameInput');
            const filename = (filenameInput && filenameInput.value.trim()) || defaultFilename;

            this.downloadFile(filename, csvContent);
            this.showStatus('exportStatus', `数据已导出为 CSV 文件：${filename}`, 'success');
        }

        exportExcel() {
            if (!this.filteredData.length) {
                this.showStatus('exportStatus', '没有可导出的数据', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            const wsData = [];

            // 添加表头
            const headerRow = this.selectedColumns.map(col => ({ v: col, s: { fill: { fgColor: { rgb: "FF9800" } } } }));
            wsData.push(headerRow);

            // 添加数据行
            this.filteredData.forEach(row => {
                const rowData = this.selectedColumns.map(col => ({ v: row[col] || '' }));
                wsData.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const defaultFilename = `export-${timestamp}.xlsx`;
            const filenameInput = document.getElementById('filenameInput');
            const filename = (filenameInput && filenameInput.value.trim()) || defaultFilename;

            XLSX.writeFile(wb, filename);
            this.showStatus('exportStatus', `数据已导出为 Excel 文件：${filename}`, 'success');
        }
    }

    window.excelApp = new EnhancedExcelManager();
    </script>
</body>
</html>